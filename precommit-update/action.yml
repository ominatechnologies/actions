name: Update
description: checkout branch, install pre-commit, update, create PR

inputs:
  token:
    description: git pat to execute git related commands
    required: true
  python:
    description: python version to use
    required: true
    default: "3.8"
  test-mode:
    description: to test the workflow
    required: false

runs:
  using: composite
  steps:
    - uses: actions/checkout@v2
      with:
        token: ${{ inputs.token }}
    - name: Checkout branch
      shell: bash
      run: |
        # Git config
        git config user.name "GitHub Actions"
        git config user.email "scott.tiger@ominatechnologies.com"
        # Fetch latest
        git fetch -ap
        # Switch to the branch or create it
        git checkout -B update-precommit
        git reset --hard origin/update-precommit || git push -u origin update-precommit
    - uses: actions/setup-python@v2
      with:
        python-version: ${{ inputs.python }}
        cache: pip
        cache-dependency-path: LICENSE
    - name: Install tools and requirements
        shell: bash
        run: |
          pip install -U pip setuptools wheel pre-commit
          pip install -r requirements.dev.txt ${{ inputs.install }}
          - uses: actions/cache@v2
            with:
              path: ~/.cache/pre-commit
              key: pre-commit
    - name: Update pre-commit
        shell: bash
        run: pre-commit autoupdate
    - name: Check if updates
        shell: bash
        id: update-pre-commit
        run: echo "::set-output name=state::$(git diff --name-only origin/main HEAD | grep -c pre-commit-config)"
    - name: Create or Update Pull Request
      if: ${{ steps.update-pre-commit.outputs.state != 0 && ! inputs.test-mode }}
      uses: gr2m/create-or-update-pull-request-action@v1.x
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      with:
        title: "pre-commit autoupdate"
        body: |
          Update report
          - Bump ${{ inputs.sender }} to ${{ inputs.tag }}
          - Auto-generated by [create-pull-request](https://github.com/gr2m/create-or-update-pull-request-action)
        branch: main
        path: "."
        commit-message: "chore: Autoupdate pre-commit [skip ci]"
        author: "GitHub Actions <scott.tiger@ominatechnologies.com>"
        auto-merge: squash
        update-pull-request-title-and-body: false
